<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad 6 - Refactorización SOLID</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>
<body>

<script>

class UserFetcher {
    static async fetchAllUsers() {
        const response = await fetch('https://jsonplaceholder.typicode.com/users/');
        if (!response.ok) {
            throw new Error('Error al obtener la lista de usuarios');
        }
        return response.json();
    }
    
    static async fetchUserDetail(userId) {
        const response = await fetch('https://jsonplaceholder.typicode.com/users/' + userId);
        if (!response.ok) {
            throw new Error('Error al obtener detalles del usuario ' + userId);
        }
        return response.json();
    }
}


class UserTableView extends HTMLElement {
    constructor() {
        super();
        this.innerHTML = '<h4>Cargando datos...</h4>';
        
        this.DATA_KEYS = ['id', 'username', 'name', 'email', 'website', 'phone'];
        this.CUSTOM_HEADERS = ['ID', 'Usuario', 'Nombre', 'Correo', 'Web', 'Celular'];
    }

    render(data, rowClickHandler) {
        this.innerHTML = '';
        
        const table = document.createElement('table');
        table.className = 'w3-table w3-striped w3-bordered w3-hoverable w3-card'; 
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        const headerRow = document.createElement('tr');
        headerRow.className = 'w3-light-grey'; 
        
       
        var self = this; 
        
        this.CUSTOM_HEADERS.forEach(function(headerText) {
            const th = document.createElement('th');
            th.innerText = headerText;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        
        data.forEach(function(item) {
            const row = document.createElement('tr');
            
            row.dataset.userId = item.id; 
            
            // Reemplazo de flecha en el onclick
            row.onclick = function() {
                rowClickHandler(item.id);
            };

            self.DATA_KEYS.forEach(function(key) { 
                const td = document.createElement('td');
                
                if (key === 'email') { 
                    const emailTag = document.createElement('span');
                    emailTag.className = 'w3-tag w3-round w3-light-blue';
                    emailTag.innerText = item[key];
                    td.appendChild(emailTag);
                } else {
                    td.innerText = item[key];
                }
                row.appendChild(td);
            });
            tbody.appendChild(row);
        });
        

        table.appendChild(thead);
        table.appendChild(tbody);
        this.appendChild(table);
    }
}
customElements.define('x-user-table-view', UserTableView);



class UserApp extends HTMLElement {
    constructor() {
        super();
        this.tableView = document.createElement('x-user-table-view');
        this.appendChild(this.tableView);
        
        this.modal = document.createElement('div');
        this.modal.className = 'w3-modal';
        this.modalContent = document.createElement('div');
        this.modalContent.className = 'w3-modal-content w3-card-4 w3-animate-opacity';
        this.modalContent.style.padding = '16px';
        this.modal.appendChild(this.modalContent);
        this.appendChild(this.modal);
        
        this.isModalOpen = false;
    }

    
    async handleRowClick(userId) {
        if (this.isModalOpen) return;
        this.isModalOpen = true;

        this.modalContent.innerHTML = '<h5>Cargando detalles del usuario ' + userId + '...</h5>';
        this.modal.style.display = 'block';

        try {
            const userDetail = await UserFetcher.fetchUserDetail(userId);
            
            this.modalContent.innerHTML = `
                <span onclick="document.querySelector('x-user-app').closeModal()" 
                      class="w3-button w3-display-topright">&times;</span>
                <h3>Detalles de ${userDetail.name}</h3>
                <p><strong>Dirección:</strong> ${userDetail.address.street}, ${userDetail.address.city}</p>
                <p><strong>Compañía:</strong> ${userDetail.company.name}</p>
            `;

        } catch (error) {
            this.modalContent.innerHTML = `<p class="w3-text-red">Error al cargar detalles.</p>`;
        }
    }

    closeModal() {
        this.modal.style.display = 'none';
        this.isModalOpen = false;
    }

    async connectedCallback() {
        try {
            const userData = await UserFetcher.fetchAllUsers();
            this.tableView.render(userData, this.handleRowClick.bind(this));
            
        } catch (error) {
            this.tableView.innerHTML = `<p class="w3-text-red">No se pudo cargar la aplicación.</p>`;
        }
    }
}

customElements.define('x-user-app', UserApp);

function main() {
    let app = new UserApp();
    document.body.appendChild(app);
}

window.onload = main;
</script>

</body>
</html>